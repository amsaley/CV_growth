---
title: "CV growth"
output: html_document
date: "2023-09-20"
editor_options: 
  chunk_output_type: console
---

loading in library and datafiles
```{r}
setwd("C:/Users/alish/OneDrive/Documents/GitHub/CV_growth/data files")
library(readxl)
library(lme4)
library(lmerTest)
dat = read.csv("C:/Users/alish/OneDrive/Documents/GitHub/CV_growth/data files/dat.processed.csv")
control = read_xlsx("control cv.xlsx")
```
grouping treatments by treatments; creating end and inc
```{r}
dat$T. = 0
dat[dat$sal.treat.x == "amb" & dat$TA.treat.x == "1000",]$T. <- "T1"
dat[dat$sal.treat.x == "amb" & dat$TA.treat.x == "2000",]$T. = "T2"
dat[dat$sal.treat.x == "amb" & dat$TA.treat.x == "3000",]$T. = "T3"

dat[dat$sal.treat.x == "low" & dat$TA.treat.x == "1000",]$T. = "t1"
dat[dat$sal.treat.x == "low" & dat$TA.treat.x == "2000",]$T. = "t2"
dat[dat$sal.treat.x == "low" & dat$TA.treat.x == "3000",]$T. = "t3"

nT1 = nrow(dat[dat$T. == "T1" & dat$dps == 36,])
nT2 = nrow(dat[dat$T. == "T2" & dat$dps == 36,])
nT3 = nrow(dat[dat$T. == "T3" & dat$dps == 36,])
nt1 = nrow(dat[dat$T. == "t1" & dat$dps == 36,])
nt2 = nrow(dat[dat$T. == "t2" & dat$dps == 36,])
nt3 = nrow(dat[dat$T. == "t3" & dat$dps == 36,])

dat$nrow = 0
dat[dat$T. == "T1",]$nrow <- nT1
dat[dat$T. == "T2",]$nrow <- nT2
dat[dat$T. == "T3",]$nrow <- nT3
dat[dat$T. == "t1",]$nrow <- nt1
dat[dat$T. == "t2",]$nrow <- nt2
dat[dat$T. == "t3",]$nrow <- nt3

#after 5 weeks of exposure
end = dat[dat$dps == 36,]
end$Net_growth.w.trans = log(end$Net_growth.w + 10)

plot((Net_growth.w.trans) ~ med.ta, pch = 19, col = as.factor(sal.treat.x), data = end)

#for incremental growth we need to delete the first time step
inc = subset(dat,
             dps >1)

```

MODELING ------------------------

         MODEL 1: What is the effect of [TA] on growth (amb S)?
```{r}
#ambient salinity
amb.S = as.data.frame(end[end$sal.treat.x == "amb",])
```
on shell growth; NO DIFFERENCE
```{r}
#looking at the effect of TA (vs omega?)
boxplot(amb.S$Net_growth.d ~ as.factor(round(amb.S$med.ta,-3)))

boxplot(amb.S$Net_growth.d ~ as.factor(round(amb.S$med.OmC,0)))

```
incremental split on shell growth? growth declined in latter half of experiment overall. in the latter half of the experiment the high TA treatment had higher incremental growth than the two low TA treatments
```{r}
boxplot(incr_growth.d ~ dps + round(med.ta,-3), data = inc[inc$med.S > 31,], outline = F)

inc$dps.F = as.factor(inc$dps)
library(nlme)
# Fit the mixed-effects model with two treatment factors
mixed_model <- lme(incr_growth.d ~ TA.treat.x * dps.F, random = ~1|bucket, data = inc[inc$med.S > 31,])

# Summary of the mixed-effects model
summary(mixed_model)
library(multcomp)
# Perform the post hoc analysis (Tukey's HSD)
posthoc_results <- glht(mixed_model, linfct = mcp(TA.treat.x = "Tukey", dps.F = "Tukey"))

# Summary of post hoc analysis
summary(posthoc_results)

# Summary of ANOVA
anova_model = aov(incr_growth.d ~ TA.treat.x * dps.F, data = inc[inc$med.S > 31,])
summary(anova_model)
library(agricolae)
# Perform Tukey's HSD test for the interaction
tukey_interaction <- HSD.test(anova_model, trt = c("TA.treat.x", "dps"), console = TRUE)
# Print the results of the Tukey's HSD test for the interaction
print(tukey_interaction)

# FIGURE

#incremental growth rates decline in amb TA conditions, suggesting that maybe the effect of altered
boxplot(incr_growth.d ~ dps : TA.treat.x, pch = 19, ylab = NA, xlab = NA, col = unique(c("grey","grey40")), names= NA, ylim = c(-1,3.6), frame.plot = F, xlim = c(0.5,9), axes = F, data = dat[dat$sal.treat.x == "amb",], outline = F)
text(x = 7.5, y = 2.9, labels = c("Time increment"), cex = 1.25)
legend(x=6,y=2.85,fill = c("grey","grey40"),legend = c("0 - 18 dps","18 - 36 dps"),bty = "n", cex = 1.2, x.intersp=0.4)
lines(x= c(0.25,7), y=c(-1,-1), lwd = 2)
lines(x= c(0.25,0.25), y=c(-1,3.5), lwd = 2)
axis(side = 1, line = -0.9, tick = F, at = c(1.5,3.5,5.5), labels = c("X","X","X"), cex.axis = 1.1)
axis(side = 1, line = 0.25, tick = F, at = 3.5, labels = "Median alkalinity concentration (umol kg -1)", cex.axis = 1.1)
axis(side = 1, line = 1.25, tick = F, at = c(1.5,3.5,5.5), labels = c("-X%","-X%","+X%"), cex.axis = 0.8)
axis(side = 1, line = 2, tick = F, at = 3.5, labels = "Alkalinity relative to ambient (2250 umol kg-1)", cex.axis = 0.8)
axis(side = 2, line = -0.75, tick = F, at = c(-.5,.5,1.5,2.5,3.5), labels = c("-0.5","0.5","1.5","2.5", "3.5"), cex.axis = 1.25, las = 1)
axis(side = 2, line = 2.1, tick = F, at = 1.25, labels = 'Incremental growth rate', cex.axis = 1.1)
axis(side = 2, line = 0.75, tick = F, at = 1.25, labels = expression(paste(' (mm'^2,' d'^-1,')')), cex.axis = 1.1)

text(x = c(1,3,5), y = c(3.5,2.75,2.5), label = "a", cex = 1.15)
text(x = 6, y = 1.75, label = "b", cex = 1.15)
text(x = c(2,4), y = c(1,1.5), label = "c", cex = 1.15)



```
Explore the data + check assumptions:
Checking assumptions of ANOVA model:
1. Normality – Each sample was drawn from a normally distributed population.
2. Equal Variances – The variances of the populations that the samples come from are equal.
3. Independence – The observations in each group are independent of each other and the observations within groups were obtained by a random sample.
```{r}


#look at the SPREAD in the relationships between the predictors and response
plot(Net_growth.d ~ med.ta + med.S, data = end, pch = 19, ylim = c(-0.5,2), col = as.factor(sal.treat.x))

#need to log it but have to transform it first amb.S$Net_growth.w.trans to use now

#replot to see how it looks:
plot(Net_growth.d ~ med.ta, data = amb.S, pch = 19) #much better; will use this response for adhering to linearity and additivity.
boxplot(Net_growth.d ~ TA.treat.x, data = amb.S, pch = 19, outline = F) #looks good; spread of any box is no more than 2X greater than another

#look at the distributions of the response variables
hist((end$Net_growth.w.trans)) #looking for Gaussian distribution
#looks okay!
```

```{r}
library(nlme)
#model with all predictors. 
mod.full <- lme((Net_growth.w) ~ SA.start +
                  (med.ta) + med.S, random  = ~1 | bucket, data= (end), na.action=na.omit)
summary(mod.full)

#there is NO effect of S but a small effect of TA on oyster growth
# was it big enough to be captured amongst our groups? 

#ambient S: net growth did NOT differ among the three TA treatments 
mod.hiS <- lme((Net_growth.w/SA.start) ~ 
                  factor(TA.treat.x), random  = ~1 | bucket, data= (dat[dat$dps == 36 & dat$sal.treat.x == "amb",]), na.action=na.omit)
anova(mod.hiS)

#low S: net growth DID differ among the three TA treatments
mod.lowS <- lme((Net_growth.w/SA.start) ~ 
                  factor(TA.treat.x), random  = ~1 | bucket, data= (dat[dat$dps == 36& dat$sal.treat.x == "low",]), na.action=na.omit)
anova(mod.lowS) #difference in the average growth

#which ones? highest treatment was different than both lower, but no difference between lower
library(emmeans)
emmeans(mod.lowS, list (pairwise ~ TA.treat.x), adjust = "tukey")











mod.full = aov( ~ factor(TA.treat.x) + Error, data=end, na.action=na.omit)
summary(mod.full) #Bucket is our random effect because we want to make sure that individuals grown in the same bucket are accounted for

mod.RE = aov(Net_growth.w.MODEL ~ factor(), data=end, na.action=na.omit)

anova(mod.full,mod.RE)


# QQ Plot: look for datapoints falling along QQ line
    #potential assumptions violated: Normality (if data fall heavily off of QQ line)
    #can also use hist(resid(model)) to check for even distribution
qqnorm(resid(mod.full)) #checks normality of the residuals
qqline(resid(mod.full)) #adds line
hist(resid(mod.full)) #pretty normal normal distribution of residuals


TukeyHSD(mod.full, factor("end$TA.treat.x"))
plot(TukeyHSD(mod, factor("end$TA.treat.x")))

```
Fixed effects:
```{r}


```
Random effects:
```{r}


```
Final Model:
```{r}


```       
         
         MODEL 2: Influence of salinity (just looking at TA between 1800 and 2200 umol kg) on net growth and CI?
```{r}
g = end[end$sal.treat.x == "amb" & end$TA.treat.x == 2000,]
gg = end[end$sal.treat.x == "low" & end$TA.treat.x == 3000,]
#ambient salinity
amb.TA = rbind(g,gg)
```
on shell growth; HIGHER GROWTH IN LOW s (similar TA and high >2.5 OmC)
```{r}
#looking at the effect of TA (vs omega?)
boxplot(amb.TA$Net_growth.d ~ amb.TA$sal.treat.x, outline = F)
# Summary of ANOVA
anova_model = aov(Net_growth.d ~ sal.treat.x, data = amb.TA)
summary(anova_model)
library(agricolae)
# Perform Tukey's HSD test for the interaction
tukey <- HSD.test(anova_model, trt = "sal.treat.x", console = TRUE)

```
incremental split on shell growth? 
```{r}
g1 = inc[inc$sal.treat.x == "amb" & inc$TA.treat.x == 2000,]
gg1 = inc[inc$sal.treat.x == "low" & inc$TA.treat.x == 3000,]
#ambient salinity
amb.TAinc = rbind(g1,gg1)
boxplot(incr_growth.d ~ dps + round(med.S,0), data = amb.TAinc, outline = F)

amb.TAinc$sal.treat = as.factor(amb.TAinc$sal.treat.x)
amb.TAinc$dps.F = as.factor(amb.TAinc$dps)
library(nlme)
# Fit the mixed-effects model with two treatment factors
mixed_model <- lme(incr_growth.d ~ sal.treat * dps.F, random = ~1|bucket, data = amb.TAinc)

# Summary of the mixed-effects model
summary(mixed_model)
library(multcomp)
# Perform the post hoc analysis (Tukey's HSD)
posthoc_results <- glht(mixed_model, linfct = mcp(sal.treat = "Tukey", dps.F = "Tukey"))

# Summary of post hoc analysis
summary(posthoc_results)

#to figure out the letters for the plot
# Summary of ANOVA
anova_model = aov(incr_growth.d ~ sal.treat * dps.F, data = amb.TAinc)
summary(anova_model)
library(agricolae)
# Perform Tukey's HSD test for the interaction
tukey_interaction <- HSD.test(anova_model, trt = c("sal.treat", "dps"), console = TRUE)
# Print the results of the Tukey's HSD test for the interaction
print(tukey_interaction)


```

         
         MODEL 3: Effects of [TA] on net growth in reduced salinity
on shell growth
```{r}
low.S = end[end$sal.treat.x == "low",]

library(nlme)
# Fit the mixed-effects model with one treatment factors
mixed_model <- lme(incr_growth.d ~ (TA.treat.x), random = ~1|bucket, data = low.S)

# Summary of the mixed-effects model
summary(mixed_model)
library(multcomp)
# Perform the post hoc analysis (Tukey's HSD)
posthoc_results <- glht(mixed_model, linfct = mcp(TA.treat.x = "Tukey"))
summary(posthoc_results)

#after 5 weeks of exposure
boxplot(Net_growth.d ~ TA.treat.x, data = low.S, pch = 19, ylab = NA, xlab = NA, names= NA, frame.plot = F, xlim = c(0,4), axes = F, outline = F, ylim = c(-.2,2))
lines(x= c(0,0), y=c(-.2,2.5), lwd = 2)
lines(x= c(0,4), y=c(-.2,-.2), lwd = 2)
axis(side = 1, line = -1, tick = F, at = c(1,2,3), labels = c("X","X","X"), cex.axis = 1.15)
axis(side = 1, line = 0.25, tick = F, at = 2, labels = "Median total alkalinity concentration (umol kg -1)", cex.axis = 1.15)
axis(side = 1, line = 1.25, tick = F, at = c(1,2,3), labels = c("'Rain'","'Low TA river'","'High TA river'"), cex.axis = 0.8)
axis(side = 1, line = 2, tick = F, at = 2, labels = "Simulated mixing of freshwater source", cex.axis = 0.8)
axis(side = 2, line = -1.5, tick = F, at = c(0,.5,1.0,1.5,2), labels = c("0","0.5", "1.0", "1.5","2"), cex.axis = 1.25, las = 1)
axis(side = 2, line = 1.25, tick = F, at = 1, labels = 'Net growth rate', cex.axis = 1.15)
axis(side = 2, line = -0.25, tick = F, at = 1, labels = expression(paste('(mm'^2,' wk'^-1,')')), cex.axis = 1.15)

text(x = 1, y = 1.5, label = "a", cex = 1.15)
text(x = 2, y = 1.0, label = "a", cex = 1.15)
text(x = 3, y = 1.8, label = "b", cex = 1.15)


```

incremental split on shell growth? 
```{r}

inc$dps.F = as.factor(inc$dps)

low.Sinc = inc[inc$sal.treat.x == "low",]

low.Sinc$ta.treat = as.factor(low.Sinc$TA.treat.x)
low.Sinc$dps.F = as.factor(low.Sinc$dps)
library(nlme)
# Fit the mixed-effects model with two treatment factors
mixed_model <- lme(incr_growth.d ~ ta.treat * dps.F, random = ~1|bucket, data = low.Sinc)

# Summary of the mixed-effects model
summary(mixed_model)
library(multcomp)
# Perform the post hoc analysis (Tukey's HSD)
posthoc_results <- glht(mixed_model, linfct = mcp(ta.treat = "Tukey", dps.F = "Tukey"))

# Summary of post hoc analysis
summary(posthoc_results)

#to figure out the letters for the plot
# Summary of ANOVA
anova_model = aov(incr_growth.d ~ ta.treat * dps.F, data = low.Sinc)
summary(anova_model)
library(agricolae)
# Perform Tukey's HSD test for the interaction
tukey_interaction <- HSD.test(anova_model, trt = c("ta.treat", "dps"), console = TRUE)
# Print the results of the Tukey's HSD test for the interaction
print(tukey_interaction)

# FIGURE

#incremental growth rates decline in amb TA conditions, suggesting that maybe the effect of altered
boxplot(incr_growth.d ~ dps : TA.treat.x, pch = 19, ylab = NA, xlab = NA, col = unique(c("grey","grey40")), names= NA, ylim = c(-1,3.6), frame.plot = F, xlim = c(0.5,9), axes = F, data = dat[dat$sal.treat.x == "low",], outline = F)
text(x = 7.5, y = 2.9, labels = c("Time increment"), cex = 1.25)
legend(x=6,y=2.85,fill = c("grey","grey40"),legend = c("0 - 18 dps","18 - 36 dps"),bty = "n", cex = 1.2, x.intersp=0.4)
lines(x= c(0.25,7), y=c(-1,-1), lwd = 2)
lines(x= c(0.25,0.25), y=c(-1,3.5), lwd = 2)
axis(side = 1, line = -0.9, tick = F, at = c(1.5,3.5,5.5), labels = c("X","X","X"), cex.axis = 1.1)
axis(side = 1, line = 0.25, tick = F, at = 3.5, labels = "Median alkalinity concentration (umol kg -1)", cex.axis = 1.1)
axis(side = 1, line = 1.25, tick = F, at = c(1.5,3.5,5.5), labels = c("'Rain'","'Low TA river'","'High TA river'"), cex.axis = 0.8)
axis(side = 1, line = 2, tick = F, at = 3.5, labels = "Simulated mixing of freshwater source", cex.axis = 0.8)
axis(side = 2, line = -0.75, tick = F, at = c(-.5,.5,1.5,2.5,3.5), labels = c("-0.5","0.5","1.5","2.5", "3.5"), cex.axis = 1.25, las = 1)
axis(side = 2, line = 2.1, tick = F, at = 1.25, labels = 'Incremental growth rate', cex.axis = 1.1)
axis(side = 2, line = 0.75, tick = F, at = 1.25, labels = expression(paste(' (mm'^2,' d'^-1,')')), cex.axis = 1.1)

text(x = c(1,2,3,4,5,6), y = c(2.5,1,1.75,1,3.6,1.6), label = c("b","d","c","d","a","c"), cex = 1.15)

plot(low.S$med.ta ~ low.S$med.OmC)
unique(round(low.S$med.ta,-2))
unique(round(low.S$med.OmC,0))

```
         
         MODEL 4: effects of TA and S on Gut and CI
```{r}
#looking at the effect of TA (vs omega?) on gut and CI
boxplot(amb.S$gut.wt ~ as.factor(round(amb.S$med.ta,-3)))

boxplot(amb.S$gut.wt ~ as.factor(round(amb.S$med.OmC,0)))

boxplot(amb.S$CI ~ as.factor(round(amb.S$med.ta,-3)))

boxplot(amb.S$CI ~ as.factor(round(amb.S$med.OmC,0)))

#looking at the effect of TA (vs omega?)
boxplot(amb.TA$gut.wt ~ amb.TA$sal.treat.x, outline = F)

# Fit the mixed-effects model with two treatment factors
mixed_model <- lme(gut.wt ~ sal.treat.x, random = ~1|bucket, data = amb.TA)

# Summary of the mixed-effects model
summary(mixed_model)
library(multcomp)

#looking at the effect of TA (vs omega?)
boxplot(amb.TA$CI ~ amb.TA$sal.treat.x, outline = F)

# Fit the mixed-effects model with two treatment factors
mixed_model <- lme(CI ~ sal.treat.x, random = ~1|bucket, data = amb.TA)

# Summary of the mixed-effects model
summary(mixed_model)

#looking at the effect of TA (vs omega?) low S
boxplot(gut.wt ~ TA.treat.x, data = low.S, outline = F)
#looking at the effect of TA (vs omega?) low S
boxplot(CI ~ TA.treat.x, data = low.S, outline = F)

# Fit the mixed-effects model with two treatment factors
mixed_model <- lme(CI ~ TA.treat.x, random = ~1|bucket, data = low.S)

# Summary of the mixed-effects model
summary(mixed_model)

```
        
         MODEL 5: incremental growth per start SA (dps = 0, dps = 18); survival
```{r}
inc$incr_growth.d.mm2 = NA
inc$SA.mod = NA
inc[inc$dps == 18,]$incr_growth.d.mm2 = inc[inc$dps == 18,]$incr_growth.d/inc[inc$dps == 18,]$SA.start

inc[inc$dps == 18,]$SA.mod <- (inc[inc$dps == 18,]$SA.start)

inc[inc$dps == 36,]$SA.mod <- (inc[inc$dps == 36,]$SA.dps18)

inc[inc$dps == 36,]$incr_growth.d.mm2 = inc[inc$dps == 36,]$incr_growth.d/inc[inc$dps == 36,]$SA.dps18


summary(lme(incr_growth.d.mm2 ~ as.numeric(SA.mod) * as.factor(dps), random = ~1|bucket, data = inc))


#Figure 
boxplot(inc$incr_growth.d.mm2 ~ inc$dps)


#extra figure to alter
plot(inc$incr_growth.d.mm2 ~ inc$SA.mod, bty = "n", type = "n", axes = F, xlim = c(50,300), ylim = c(-0.012,0.03), xlab = NA, ylab = NA)

points((inc[inc$dps == 36,]$incr_growth.d.mm2 ~ inc[inc$dps == 36,]$SA.mod), pch = 21, bg = "grey40")
points((inc[inc$dps == 18,]$incr_growth.d.mm2 ~ inc[inc$dps == 18,]$SA.mod), pch = 21, bg = "grey")
lines(x= c(50,300), y=c(-0.012,-0.012), lwd = 2)
lines(x= c(50,50), y=c(-0.012,0.03), lwd = 2)

axis(side = 1, line = -0.9, tick = F, at = c(53,100,150,200,250,300), labels = c("50","100","150","200","250","300"), cex.axis = 1.1)
axis(side = 1, line = 0.75, tick = F, at = 175, labels = "Size at start of increment (mm2)", cex.axis = 1.1)

axis(side = 2, line = -1.75, tick = F, at = c(-0.005,0.005,0.015,0.025), labels = c("-0.005","0.005","0.015","0.025"), cex.axis = 1.1, las = 2)
axis(side = 2, line = 2.25, tick = F, at = 0.01, labels = "incremental per area", cex.axis = 1.1)
axis(side = 2, line = 1.25, tick = F, at = 0.01, labels = "growth rate (d-1)", cex.axis = 1.1)

lines(x=c(55,300), y=c(0.0063,-0.0007266), lwd = 3, col = "grey", lty = 2) #intercept > 0 but slope == 0
lines(x=c(55,300), y=c(0.002788592,-0.0045456), lwd = 3, col = "grey40", lty = 2)

```         
         
mortality/loss
```{r}
mort = dat %>%
  # first sort by year
  group_by(T.) %>% summarise(mort = (49*2) - mean(nrow),mort.frac = mort/(49*2), ave.tiss = mean(gut.wt), ave.net.d = mean(Net_growth.d))

dat$mort = NA
dat[dat$T. == "T1",]$mort <- mort[mort$T. == "T1",]$mort.frac
dat[dat$T. == "T2",]$mort <- mort[mort$T. == "T2",]$mort.frac
dat[dat$T. == "T3",]$mort <- mort[mort$T. == "T3",]$mort.frac
dat[dat$T. == "t1",]$mort <- mort[mort$T. == "t1",]$mort.frac
dat[dat$T. == "t2",]$mort <- mort[mort$T. == "t2",]$mort.frac
dat[dat$T. == "t3",]$mort <- mort[mort$T. == "t3",]$mort.frac

dat$surv = NA
dat$surv = 1 - dat$mort

# mort vectors
T1m = mean(dat[dat$T. == "T1",]$mort)
T2m = mean(dat[dat$T. == "T2",]$mort)
T3m = mean(dat[dat$T. == "T3",]$mort)
t1m = mean(dat[dat$T. == "t1",]$mort)
t2m = mean(dat[dat$T. == "t2",]$mort)
t3m = mean(dat[dat$T. == "t3",]$mort)
  
# combine two vectors using cbind 
# function
mort_data=cbind(T1m,T2m, T3m, t1m, t2m, t3m)


  dat$nrow.plate = NA
#to figure out how to get plate level mortality for the error bars
  # Iterate over each plate#
for (plate in 1:12) {
  # Subset data for the current Bin#
  subset_data <- end[end$Plate.x == plate, ]
  
  # Calculate the median TA for the current Bin#
  nrow.plate <- nrow(subset_data)
  
  # Assign the median value to the corresponding row in the final result dataframe
  dat[dat$Plate.x == plate, "nrow.plate"] <- nrow.plate
}
  SE.T1 = mean(unique(dat[dat$T. == "T1",]$mort))/sqrt(2)
  SE.T2 = mean(unique(dat[dat$T. == "T2",]$mort))/sqrt(2)
  SE.T3 = mean(unique(dat[dat$T. == "T3",]$mort))/sqrt(2)
  SE.t1 = mean(unique(dat[dat$T. == "t1",]$mort))/sqrt(2)
  SE.t2 = mean(unique(dat[dat$T. == "t2",]$mort))/sqrt(2)
  SE.t3 = mean(unique(dat[dat$T. == "t3",]$mort))/sqrt(2)
  
# pass this college_data to the 
# barplot
barplot(1-mort_data,beside=T, xaxt='n', ann=FALSE, yaxt='n', xlim = c(0,13), ylim = c(0,1))
lines(x = c(0,15),y=c(0,0), lwd = 1.5)
lines(x = c(0,0),y=c(0,1), lwd = 1.5)
axis(side = 2, labels = c("0","0.2","0.4","0.6","0.8","1.0"), at = c(0,0.2,0.4,0.6,0.8,1), las = 1, tick = F, line = -1.25)
axis(side = 2, labels = "Proportion survival", at = 0.5, cex = 1.5, line = 0.75, tick = F)
axis(side = 1, labels = c("ambient (S = 34)","low (S = 27)"), at = c(3.5,9.5), cex = 1.5, line = -0.5, tick = F)
  axis(side = 1, labels = c("X","X","X"), at = c(1.5,3.5,5.5), cex = 1.5, line = 0.75, tick = F)
    axis(side = 1, labels = c("X","X","X"), at = c(7.5,9.5,11.5), cex = 1.5, line = 0.75, tick = F)
  axis(side = 1, labels = c("total alkalinity concentration"), at = c(6.5), cex = 1.5, line = 2, tick = F)
  abline(h=0.9, lty = 2, lwd = 2)
  lines(x = c(1.5,1.5), y = c((1-T1m)+SE.T1, (1-T1m)-SE.T1), lwd = 2)
    lines(x = c(3.5,3.5), y = c((1-T2m)+SE.T2, (1-T2m)-SE.T2), lwd = 2)
    lines(x = c(5.5,5.5), y = c((1-T3m)+SE.T3, (1-T3m)-SE.T3), lwd = 2)
    lines(x = c(7.5,7.5), y = c((1-t1m)+SE.t1, (1-t1m)-SE.t1), lwd = 2)
    lines(x = c(9.5,9.5), y = c((1-t2m)+SE.t2, (1-t2m)-SE.t2), lwd = 2)
    lines(x = c(11.5,11.5), y = c((1-t3m)+SE.t3, (1-t3m)-SE.t3), lwd = 2)
  

```
         
         
         
         S, TA, T treatments (make sure the ones we are clustering actually should cluster statistically)
         
         

what is the effect of TA on growth rate?
```{r}


boxplot(((amb.S$Net_growth.w)) ~ amb.S$TA.treat.x, pch = 19, ylab = NA, xlab = NA, names= NA, ylim = c(-5,15), frame.plot = F, xlim = c(0,4), axes = F)
lines(x= c(0,4), y=c(-5,-5), lwd = 2)
lines(x= c(0,0), y=c(-5,15), lwd = 2)
axis(side = 1, line = -1, tick = F, at = c(1,2,3), labels = c("X","X","X"), cex.axis = 1.15)
axis(side = 1, line = 0.25, tick = F, at = 2, labels = "Median total alkalinity concentration (umol kg -1)", cex.axis = 1.15)
axis(side = 1, line = 1.25, tick = F, at = c(1,2,3), labels = c("-60%","-17%","+26%"), cex.axis = 0.8)
axis(side = 1, line = 2, tick = F, at = 2, labels = "Alkalinity change relative to ambient (2250 umol kg-1)", cex.axis = 0.8)
axis(side = 2, line = -1.5, tick = F, at = c(-5,0,5,10,15), labels = c("-5","0","5", "10", "15"), cex.axis = 1.25, las = 1)
axis(side = 2, line = 1.25, tick = F, at = 5, labels = 'Net surface area growth rate', cex.axis = 1.15)
axis(side = 2, line = -0.25, tick = F, at = 5, labels = expression(paste('(mm'^2,' wk'^-1,')')), cex.axis = 1.15)

#text(x = 1, y = 10, label = "a", cex = 1.15)
#text(x = 2, y = 8, label = "a", cex = 1.15)
#text(x = 3, y = 13, label = "b", cex = 1.15)

```
what is the effect of TA under low S conditions?
```{r}

mod = aov((Net_growth.w/SA.start) ~ factor(TA.treat.x), data=low.S, na.action=na.omit)
TukeyHSD(mod, factor("end$TA.treat.x"))
plot(TukeyHSD(mod, factor("end$TA.treat.x")))

```
incremental growth
```{r}
dat = dat[dat$dps != 0,]
#amb salinity
amb.S = amb.S[amb.S$dps != 0,]


##########################
low.S = low.S[low.S$dps != 0,]
boxplot(low.S$incr_growth.w ~ low.S$dps : low.S$TA.treat.x, pch = 19, ylab = NA, xlab = NA, col = unique(c("grey","grey40")), names= NA, ylim = c(-7,25), frame.plot = F, xlim = c(0.5,9), axes = F)
text(x = 7.5, y = 23, labels = c("Exposure period"), cex = 1.25)
legend(x=6,y=22.5,fill = c("grey","grey40"),legend = c("0 - 18 dps","18 - 36 dps"),bty = "n", cex = 1.2, x.intersp=0.4)
lines(x= c(0.25,7), y=c(-8,-8), lwd = 2)
lines(x= c(0.25,0.25), y=c(-8,25), lwd = 2)

axis(side = 1, line = -0.9, tick = F, at = c(1.5,3.5,5.5), labels = c("645","1414","2126"), cex.axis = 1.1)
axis(side = 1, line = 0.25, tick = F, at = 3.5, labels = "Median total alkalinity concentration (umol kg -1)", cex.axis = 1.1)
axis(side = 1, line = 1.25, tick = F, at = c(1.5,3.5,5.5), labels = c("'Rain'","'Low TA river'","'High TA river'"), cex.axis = 0.8)
axis(side = 1, line = 2, tick = F, at = 3.5, labels = "Simulated mixing of freshwater source", cex.axis = 0.8)
axis(side = 2, line = -0.75, tick = F, at = c(-5,5,15,25), labels = c("-5","5","15","25"), cex.axis = 1.25, las = 1)
axis(side = 2, line = 2.1, tick = F, at = 10, labels = 'Incremental surface area', cex.axis = 1.1)
axis(side = 2, line = 0.75, tick = F, at = 10, labels = expression(paste('growth rate (mm'^2,' wk'^-1,')')), cex.axis = 1.1)


mod = aov(incr_growth.w ~ factor(TA.treat.x) : factor(dps), data=low.S, na.action=na.omit)
TukeyHSD(mod, factor("TA.treat.x:dps"))
plot(TukeyHSD(mod, factor("TA.treat.x:dps")))
```

shell properties + CI
```{r}

#effect of S
        #on condition index
plot(dat$CI ~ jitter(dat$med.ta,5), pch = 19, col = as.factor(dat$sal.treat.x), xlab = "Median [TA] (umol kg -1)", ylab = "Condition Index (dry tissue mass per shell)")
points(dat[dat$sal.treat.x == "amb",]$CI ~ jitter(dat[dat$sal.treat.x == "amb",]$med.ta,5), pch = 19, cex = 1.2)
points(dat[dat$sal.treat.x == "low",]$CI ~ jitter(dat[dat$sal.treat.x == "low",]$med.ta,5), pch = 17, cex = 1.2)

boxplot(amb[amb$dps == 36,]$CI ~ amb[amb$dps == 36,]$sal.treat.x, pch = 19, col = "grey40", ylab = NA, xlab = NA, names= NA, ylim = c(0,0.03), frame.plot = F, xlim = c(0,3), axes = F)
lines(x= c(0,4), y=c(0,0), lwd = 2)
lines(x= c(0,0), y=c(0,0.03), lwd = 2)
axis(side = 1, line = -1, tick = F, at = c(1,2), labels = c("Ambient","Reduced"), cex.axis = 1.25)
axis(side = 1, line = .5, tick = F, at = 1.5, labels = "Salinity Level", cex.axis = 1.25)
axis(side = 2, line = -1.75, tick = F, at = c(0,0.0050,0.01,0.015,0.02,0.025,0.03), labels = c("0","0.005","0.01","0.015","0.02","0.025","0.03"), cex.axis = 1.25, las = 1)
axis(side = 2, line = 1.25, tick = F, at = 0.015, labels = 'Condition index (tissue/shell mass)', cex.axis = 1.25)
        #on organics in shell
boxplot(amb[amb$dps == 36,]$`%oc.ic.shell` ~ amb[amb$dps == 36,]$sal.treat.x, pch = 19, col = "grey40", ylab = NA, xlab = NA, names= NA, ylim = c(0.5,2), frame.plot = F, xlim = c(0,3), axes = F)
lines(x= c(0.25,3), y=c(0.5,0.5), lwd = 2)
lines(x= c(0.25,0.25), y=c(0.5,2), lwd = 2)
axis(side = 1, line = -1, tick = F, at = c(1,2), labels = c("Ambient","Reduced"), cex.axis = 1.25)
axis(side = 1, line = .5, tick = F, at = 1.5, labels = "Salinity Level", cex.axis = 1.25)
axis(side = 2, line = -3.5, tick = F, at = c(0.5,1,1.5,2), labels = c("0.5","1.0","1.5","2.0"), cex.axis = 1.25, las = 1)
axis(side = 2, line = 0, tick = F, at = 1.25, labels = 'Organic C in shell', cex.axis = 1.25)
axis(side = 2, line = -1.25, tick = F, at = 1.25, labels = '(% of total shell mass)', cex.axis = 1.25)

#effect of TA
        #on condition index
boxplot(amb.S[amb.S$dps == 36,]$CI ~ amb.S[amb.S$dps == 36,]$TA.treat.x, pch = 19, col = "grey40", ylab = NA, xlab = NA, names= NA, ylim = c(0,0.03), frame.plot = F, xlim = c(0,4), axes = F)
summary(aov(amb.S[amb.S$dps == 36,]$CI ~ amb.S[amb.S$dps == 36,]$TA.treat.x))
TukeyHSD(aov(amb.S$CI ~ amb.S$TA.treat.x),"amb.S$TA.treat.x")
lines(x= c(0,4), y=c(0,0), lwd = 2)
lines(x= c(0,0), y=c(0,0.03), lwd = 2)
axis(side = 1, line = -1, tick = F, at = c(1,2,3), labels = c("reduced","ambient","elevated"), cex.axis = 1.25)
axis(side = 1, line = .5, tick = F, at = 2, labels = "Alkalinity Level", cex.axis = 1.25)
axis(side = 2, line = -1.75, tick = F, at = c(0,0.0050,0.01,0.015,0.02,0.025,0.03), labels = c("0","0.005","0.01","0.015","0.02","0.025","0.03"), cex.axis = 1.25, las = 1)
axis(side = 2, line = 1.25, tick = F, at = 0.015, labels = 'Condition index (tissue/shell mass)', cex.axis = 1.25)
        #on organics in shell
boxplot(amb.S[amb.S$dps == 36,]$`%oc.ic.shell` ~ amb.S[amb.S$dps == 36,]$TA.treat.x, pch = 19, col = "grey40", ylab = NA, xlab = NA, names= NA, ylim = c(0.5,2), frame.plot = F, xlim = c(0,4), axes = F)
lines(x= c(0.25,4), y=c(0.5,0.5), lwd = 2)
lines(x= c(0.25,0.25), y=c(0.5,2), lwd = 2)
axis(side = 1, line = -1, tick = F, at = c(1,2,3), labels = c("reduced","ambient","elevated"), cex.axis = 1.25)
axis(side = 1, line = .5, tick = F, at = 2, labels = "Alkalinity Level", cex.axis = 1.25)
axis(side = 2, line = -3, tick = F, at = c(0.5,1,1.5,2), labels = c("0.5","1.0","1.5","2.0"), cex.axis = 1.25, las = 1)
axis(side = 2, line = 0, tick = F, at = 1.25, labels = 'Organic C in shell', cex.axis = 1.25)
axis(side = 2, line = -1.25, tick = F, at = 1.25, labels = '(% of total shell mass)', cex.axis = 1.25)

#effect of TA in simulated freshwater events
        #on condition index
boxplot(low.S[low.S$dps == 36,]$CI ~ low.S[low.S$dps == 36,]$TA.treat.x, pch = 19, col = "grey40", ylab = NA, xlab = NA, names= NA, ylim = c(0,0.03), frame.plot = F, xlim = c(0,4), axes = F)
summary(aov(low.S[low.S$dps == 36,]$CI ~ factor(low.S[low.S$dps == 36,]$TA.treat.x)))
TukeyHSD(aov(low.S$CI ~ low.S$TA.treat.x),"low.S$TA.treat.x")
lines(x= c(0,4), y=c(0,0), lwd = 2)
lines(x= c(0,0), y=c(0,0.03), lwd = 2)
axis(side = 1, line = -1, tick = F, at = c(1,2,3), labels = c("rain","low TA","high TA"), cex.axis = 1.25)
axis(side = 1, line = .5, tick = F, at = 2, labels = "Alkalinity Level", cex.axis = 1.25)
axis(side = 2, line = -1.75, tick = F, at = c(0,0.0050,0.01,0.015,0.02,0.025,0.03), labels = c("0","0.005","0.01","0.015","0.02","0.025","0.03"), cex.axis = 1.25, las = 1)
axis(side = 2, line = 1.25, tick = F, at = 0.015, labels = 'Condition index (tissue/shell mass)', cex.axis = 1.25)
            #on organics in shell
boxplot(low.S[low.S$dps == 36,]$`%oc.ic.shell` ~ low.S[low.S$dps == 36,]$TA.treat.x, pch = 19, col = "grey40", ylab = NA, xlab = NA, names= NA, ylim = c(0.5,2), frame.plot = F, xlim = c(0,4), axes = F)
lines(x= c(0.25,4), y=c(0.5,0.5), lwd = 2)
lines(x= c(0.25,0.25), y=c(0.5,2), lwd = 2)
axis(side = 1, line = -1, tick = F, at = c(1,2,3), labels = c("rain","low TA","high TA"), cex.axis = 1.25)
axis(side = 1, line = .5, tick = F, at = 2, labels = "Simulated FW exposure", cex.axis = 1.25)
axis(side = 2, line = -3, tick = F, at = c(0.5,1,1.5,2), labels = c("0.5","1.0","1.5","2.0"), cex.axis = 1.25, las = 1)
axis(side = 2, line = 0, tick = F, at = 1.25, labels = 'Organic C in shell', cex.axis = 1.25)
axis(side = 2, line = -1.25, tick = F, at = 1.25, labels = '(% of total shell mass)', cex.axis = 1.25)
```

linear model tries
```{r}

library(nlme)
library(lme4)
library(emmeans)

#transforming the data by making all values positive (adding 27 to the y)
dat$Net_growth.trans = dat$Net_growth/5 + 20
dat.36 = as.data.frame(dat[dat$dps == 36,])

mod.full = lme((CI) ~ med.ta + med.S , random = ~1|bucket, data = dat.36, na.action = na.exclude)
summary(mod.full)

mod.full = lme((Net_growth/5) ~ med.ta + med.S , random = ~1|bucket, data = dat.36, na.action = na.exclude)
summary(mod.full) #effect of TA only on net growth rate; did not change in lower salinity.

plot(dat.36$Net_growth/5 ~ dat.36$med.ta, col = as.factor(dat.36$sal.treat.x), pch = 19, xlab = NA, ylab = NA, bty = "n", frame.plot = F, axes = F, ylim = c(-5,12), xlim = c(400,3000))
lines(x= c(400,3500), y=c(-5,-5), lwd = 2)
lines(x= c(400,400), y=c(-5,15), lwd = 2)
lines(x= c(2250,2250), y= c(-4.8,15), lwd = 2, lty = 2, col = "grey72")
axis(side = 1, line = -1, tick = F, at = c(500,1000,1500,2000,2500,3000), labels = c("500","1000","1500","2000","2500","3000"), cex.axis = 1.15)
axis(side = 1, line = 0.5, tick = F, at = 1750, labels = "Median total alkalinity concentration (umol kg -1)", cex.axis = 1.15)
points(dat.36[dat.36$sal.treat.x == "amb",]$Net_growth/5 ~ jitter(dat.36[dat.36$sal.treat.x == "amb",]$med.ta,10), col = "black", pch = 19, cex = 1.2)
points(dat.36[dat.36$sal.treat.x == "low",]$Net_growth/5 ~ jitter(dat.36[dat.36$sal.treat.x == "low",]$med.ta,10), col = "black", pch = 17, cex = 1.2)

axis(side = 2, line = -1.5, tick = F, at = c(-4.2,0.5,5,10,15), labels = c("-5","0","5", "10", "15"), cex.axis = 1.25, las = 1)
axis(side = 2, line = 1.25, tick = F, at = 2.5, labels = 'Net surface area growth rate', cex.axis = 1.15)
axis(side = 2, line = -0.25, tick = F, at = 2.5, labels = expression(paste('(mm'^2,' wk'^-1,')')), cex.axis = 1.15)



#summary(lm((Net_growth/5) ~ med.ta + med.S, data = dat.36))

#abline(0,0.0009965, lwd = 2, col = "black")





# histograms of response variable(s); look for gaussian distribution

hist(sqrt(dat.36$Net_growth.trans))

#plot response variable by each of the predictors; look at spread of data
plot(sqrt(dat.36$Net_growth.trans) ~ (dat.36$med.S), pch = 19)
plot(sqrt(dat.36$Net_growth.trans) ~ (dat.36$med.ta), pch = 19)

#was pH important to consider? 
plot(dat.36$med.pH ~ dat.36$med.ta,col = as.factor(dat.36$sal.treat.x), pch = 19, cex = 1.5)

library(seacarb)
dat.36$om_cal = carb(flag = 8, var1 = dat.36$med.pH, var2 = dat.36$med.ta/(10^6), S = dat.36$med.S, T = 14)$OmegaCalcite
plot(dat.36$om_cal ~ dat.36$med.ta,col = as.factor(dat.36$sal.treat.x), pch = 19, cex = 1.5)


mod.full = lme(log(Net_growth.trans) ~ med.ta + med.S, random = ~1|bucket, data = dat.36, na.action = na.exclude)
summary(mod.full)
```

looking at the control; differences from control
```{r}
# SHELL WEIGHT 
plot(control$shell.wt~control$SA.mm2)
abline(lm(control$shell.wt~control$SA.mm2)) #relat between SA and wt

#after treatments
plot(end$shell.wt ~ end$SA.mm2, pch = 19, col = as.factor(end$bucket))
#add back the trend from control/
abline(lm(control$shell.wt~control$SA.mm2)) #relat between SA and wt

#writing a model that compares the slope of each treatment (n=2 bins) to the control.
mod.slope = lm(shell.wt ~ SA.mm2 + med.S + med.ta, data = end)
summary(mod.slope) #Shell wt both went up about 0.2 g per unit increase in SA mm2...it was a little higher but still similar to control. 

# TISSUE WEIGHT
boxplot(control$gut.wt~control$Plate)
summary(lm(control$gut.wt~factor(control$Plate))) #relat between gut and pre or post
# gut weight 2.24 post ave and 5.1 pre ave

#after treatments
boxplot(end$gut.wt ~ round(end$med.S,0), pch = 19)
#add back the trend from control/
boxplot(end$gut.wt ~ round(end$med.ta,-2), pch = 19)
abline(h = c(2.24,5.1),lty = 2) #relat between SA and wt

# CONDITION INDEX
boxplot((gut.wt/shell.wt)~Plate, data = control)
summary(lm((control$gut.wt/control$shell.wt)~factor(control$Plate))) #relat between gut and pre or post
# gut weight 0.0089 post ave and 0.0076 pre ave

#after treatments
boxplot((end$gut.wt/end$shell.wt) ~ round(end$med.S,0), pch = 19)
#add back the trend from control/
boxplot(end$CI ~ round(end$med.ta,-2), pch = 19)
abline(h = c(0.0089,0.0076),lty = 2) #relat between SA and wt

#quick model to see if 2000 is higher?
summary(lm(end$CI ~ factor(round(end$med.ta,-2))))

```


FIGURES -----------------------

FIG 1 : powerpoint schematic


FIG 2 : treatment conditions (4 panel made separately and then spliced together)
treatment conditions
```{r}

median.sw.conditions <- sw %>%
  group_by(Date, `Bucket#`) %>%
  summarize(med_TA = median(TA), med_S = median(S), med_pH = median(pH), med_T = median(T_c), S.treat = NA, TA.treat = NA)


median.sw.conditions[median.sw.conditions$med_S > 30,]$S.treat <- 34
median.sw.conditions[median.sw.conditions$med_S < 30,]$S.treat <- 27

median.sw.conditions = median.sw.conditions[median.sw.conditions$`Bucket#` != 7 | median.sw.conditions$`Bucket#` != 14,]

median = median.sw.conditions %>%
  group_by(`Bucket#`) %>%
  summarize(med.TA = median(med_TA), med.S = median(med_S), med.T = median(med_T), med.pH = median(med_pH))

par(mfrow = c(2,1), mar = c(2, 4, 1.5, 2))

############Total alkalinity monitoring

#amb sal
plot(med_TA ~ Date, 
     data = median.sw.conditions[median.sw.conditions$S.treat == 34,],
     pch = 19,
     col = "black",
     ylim = c(500,3200),
     las = 1,
     xlab = NA,
     ylab = NA,
     xaxt='n')
abline(h = c(967,942,1969,1941,2900,2916), col = c("grey","grey","skyblue1", "skyblue1", "goldenrod1", "goldenrod1"), lwd = 2, lty = 2)
points(med_TA ~ Date, data = median.sw.conditions[median.sw.conditions$S.treat == 34,], pch = 19, col = "black", cex = 1.1)
#low sal
plot(med_TA ~ Date, 
     data = median.sw.conditions[median.sw.conditions$S.treat == 27,],
     pch = 17,
     col = "black",
     ylim = c(500,2500),
     las = 1,
     xlab = NA,
     ylab = NA)
abline(h = c(783,798,1499,1470,2212,2185), col = c("grey24", "grey24","blue4", "blue4","green4","green4"), lwd = 2, lty = 2)
points(med_TA ~ Date, data = median.sw.conditions[median.sw.conditions$S.treat == 27,], pch = 17, col = "black", cex = 1.1)

par(mfrow = c(1,1))
# Create an empty plot (blank screen)
plot(1, type = "n", xlab = "", ylab = "", xlim = c(0, 1), ylim = c(0, 1))
# Add legend for S treatment
legend("topleft", legend = unique(median.sw.conditions$S.treat), col = "black", pch = c(17,19), title = "Salinity", cex = 1.3, pt.cex = 2)

data_sorted <- median[order(median$med.TA),]
# Add legend for TA treatment
legend("topright", legend = c(round(data_sorted$med.TA),0), col = c("grey24", "grey24","grey","grey","blue4", "blue4", "skyblue1", "skyblue1","green4","green4", "goldenrod1", "goldenrod1"), pch = 15, title = "Median [TA]", cex = 1.1, pt.cex = 2)

############Temperature monitoring

plot(median.sw.conditions$med_T ~ median.sw.conditions$Date, pch = 18, col = "black", ylim = c(10,25), cex = 1, data = median.sw.conditions, ylab = "Temperature C", xlab = "Date")

points(median.sw.conditions[median.sw.conditions$S.treat == 27,]$med_T ~ median.sw.conditions[median.sw.conditions$S.treat == 27,]$Date, pch = 17, col = "black", cex = 1.1)

points(med_T ~ Date, data = median.sw.conditions[median.sw.conditions$S.treat == 34,], pch = 19, col = "black", cex = 1.1)

############Salinity monitoring

plot(median.sw.conditions$med_S ~ median.sw.conditions$Date, pch = 18, col = "black", ylim = c(20,35), cex = 1, data = median.sw.conditions, ylab = "Salinity", xlab = "Date")

points(median.sw.conditions[median.sw.conditions$S.treat == 27,]$med_S ~ median.sw.conditions[median.sw.conditions$S.treat == 27,]$Date, pch = 17, col = "black", cex = 1.25)

points(med_S ~ Date, data = median.sw.conditions[median.sw.conditions$S.treat == 34,], pch = 19, col = "black", cex = 1.25)

############pH monitoring


```


FIG 3 : what is the effect of TA on growth rate?

FIG 4 : what is the effect of TA on growth under low S conditions?

FIG 5 : what is the effect of TA on CI under low S conditions?

FIG 6 : Incremental growth in ambient S comparing TA treatments

FIG 7 : Incremental growth in low S comparing TA treatments

